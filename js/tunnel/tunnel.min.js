let actualWidth=1500,actualHeight=750,gridWidth=actualWidth/5,gridHeight=actualHeight/5,gl,ext,view="tx_material";function init(){let e=document.getElementById("myCanvas");gl=e.getContext("webgl"),ext=gl.getExtension("OES_texture_half_float");let t=document.getElementById("object-select");t.addEventListener("change",function(e){setTexture("tx_obstacle",t.value),resetWindow()});for(const r of t.options)resetTextureImage(r.value,r.value);setTexture("tx_obstacle","circle.jpg"),gl.disable(gl.DEPTH_TEST),createProgram("reset_velocity","vertex","reset_velocity_fragment"),createProgram("render_obstacle","vertex","obstacle_render_fragment"),createProgram("obstacle_velocity","vertex","obstacle_velocity_fragment"),setUniformForProgram("obstacle_velocity","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("obstacle_velocity","u_velocity",0,"1i"),setUniformForProgram("obstacle_velocity","u_obstacle",1,"1i"),createProgram("obstacle_pressure","vertex","obstacle_pressure_fragment"),setUniformForProgram("obstacle_pressure","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("obstacle_pressure","u_pressure",0,"1i"),setUniformForProgram("obstacle_pressure","u_obstacle",1,"1i"),createProgram("render","vertex","render_fragment"),setUniformForProgram("render","u_textureSize",[actualWidth,actualHeight],"2f"),setUniformForProgram("render","u_screenSize",[actualWidth,actualHeight],"2f"),setUniformForProgram("render","u_material",0,"1i"),setUniformForProgram("render","u_obstacle",1,"1i"),createProgram("gradient_subtraction","vertex","gradient_subtraction_fragment"),setUniformForProgram("gradient_subtraction","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("gradient_subtraction","u_velocity",0,"1i"),setUniformForProgram("gradient_subtraction","u_pressure",1,"1i"),createProgram("diverge","vertex","divergence_fragment"),setUniformForProgram("diverge","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("diverge","u_velocity",0,"1i"),createProgram("jacobi","vertex","jacobi_diffusion_fragment"),setUniformForProgram("jacobi","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("jacobi","u_divergence",0,"1i"),setUniformForProgram("jacobi","u_pressure",1,"1i"),createProgram("advect_material","vertex","advect_material_fragment"),setUniformForProgram("advect_material","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("advect_material","u_screenSize",[actualWidth,actualHeight],"2f"),setUniformForProgram("advect_material","u_material",0,"1i"),setUniformForProgram("advect_material","u_velocity",1,"1i"),createProgram("advect_velocity","vertex","advect_velocity_fragment"),setUniformForProgram("advect_velocity","u_textureSize",[gridWidth,gridHeight],"2f"),setUniformForProgram("advect_velocity","u_velocity",0,"1i"),resetWindow(),render()}function render(){setSize(gridWidth,gridHeight),advectVelocity(),applyDiffusion(20),applyProjection(),setSize(actualWidth,actualHeight),advectMaterial(),window.requestAnimationFrame(render)}function advectVelocity(){executeShader("advect_velocity",["tx_velocity"],"tx_next_velocity"),executeShader("obstacle_velocity",["tx_next_velocity","tx_obstacle"],"tx_velocity")}function applyDiffusion(t){executeShader("diverge",["tx_velocity"],"tx_divergence");for(let e=0;e<t;e++)executeShader("jacobi",["tx_divergence","tx_pressure"],"tx_next_pressure"),executeShader("jacobi",["tx_divergence","tx_next_pressure"],"tx_pressure")}function applyProjection(){executeShader("obstacle_pressure",["tx_pressure","tx_obstacle"],"tx_next_pressure"),swapTextures("tx_next_pressure","tx_pressure"),executeShader("gradient_subtraction",["tx_velocity","tx_pressure"],"tx_next_velocity"),executeShader("obstacle_velocity",["tx_next_velocity","tx_obstacle"],"tx_velocity")}function advectMaterial(){executeShader("advect_material",["tx_material","tx_velocity"],"tx_next_material"),executeShader("render",[view,"tx_obstacle"]),swapTextures("tx_next_material","tx_material")}function resetWindow(){resetTextures()}function resetTextures(){resetTexture("tx_velocity",gridWidth,gridHeight),resetFrameBufferForTexture("tx_velocity"),executeShader("reset_velocity",[],"tx_velocity"),resetTexture("tx_next_velocity",gridWidth,gridHeight),resetFrameBufferForTexture("tx_next_velocity"),executeShader("reset_velocity",[],"tx_next_velocity"),resetTexture("tx_divergence",gridWidth,gridHeight),resetFrameBufferForTexture("tx_divergence"),resetTexture("tx_pressure",gridWidth,gridHeight),resetFrameBufferForTexture("tx_pressure"),resetTexture("tx_next_pressure",gridWidth,gridHeight),resetFrameBufferForTexture("tx_next_pressure"),resetTexture("tx_material",actualWidth,actualHeight),resetFrameBufferForTexture("tx_material"),resetTexture("tx_next_material",actualWidth,actualHeight),resetFrameBufferForTexture("tx_next_material")}function materialView(){view="tx_material",updateUniformForProgram("render","u_textureSize",[actualWidth,actualHeight],"2f")}function velocityView(){view="tx_velocity",updateUniformForProgram("render","u_textureSize",[gridWidth,gridHeight],"2f")}function pressureView(){view="tx_pressure",updateUniformForProgram("render","u_textureSize",[gridWidth,gridHeight],"2f")}window.onload=init;